<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP Corabastos — Supabase</title>
  <style>
    :root{--bg:#f4f6f9;--card:#fff;--accent:#0a57ff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#0f172a}
    header{background:#071025;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .app{display:flex;height:calc(100vh - 56px);min-height:calc(100vh - 56px)}
    #sidebar{width:240px;background:#0b1220;color:#fff;padding:14px;display:flex;flex-direction:column;gap:8px;position:fixed;left:0;top:56px;bottom:0;transition:transform .25s}
    #sidebar.hidden{transform:translateX(-260px)}
    #sidebar button{background:transparent;border:0;color:#cbd5e1;text-align:left;padding:10px;border-radius:8px;cursor:pointer}
    #sidebar button:hover{background:rgba(255,255,255,0.04);color:#fff}
    #sidebar button.active{background:rgba(255,255,255,0.04);color:#fff;font-weight:700}
    main{flex:1;padding:18px;margin-left:240px;overflow:auto;transition:margin-left .25s}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:14px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;margin-top:6px}
    label{font-weight:600;font-size:13px;margin-top:8px;display:block}
    button.primary{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #eef4fb;text-align:left}
    .autocomplete{position:absolute;top:38px;width:100%;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:220px;overflow:auto;z-index:9999;display:none}
    .autocomplete div{padding:10px;cursor:pointer}
    .autocomplete div:hover{background:#f1f5f9}
    @media(max-width:900px){
      #sidebar{position:fixed;left:0;top:56px;bottom:0;transform:translateX(-260px);z-index:60}
      main{padding:12px;margin-left:0}
    }
    /* modal */
    #infoModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99999;align-items:center;justify-content:center}
    #infoModal .card{max-width:420px;width:92%}
    /* role edit modal */
    #roleEditModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:100000;align-items:center;justify-content:center}
    #roleEditModal .box{background:#fff;padding:18px;border-radius:10px;width:360px}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <button id="btnMenu" class="primary" style="background:transparent;border:0;color:#fff;font-size:20px">☰</button>
    <div style="font-weight:700;font-size:18px">ERP Corabastos</div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="headerUser" class="small"></div>
    <button id="btnLogout" class="primary" style="background:#dc2626;border:0;padding:6px 10px;display:none">Cerrar sesión</button>
  </div>
</header>

<div class="app">
  <aside id="sidebar">
    <button id="menu_dashboard" data-sec="dashboard">Dashboard</button>
    <button id="menu_fundaciones" data-sec="fundaciones">Fundaciones</button>
    <button id="menu_items" data-sec="items">Items</button>
    <button id="menu_conductores" data-sec="conductores">Conductores & Placas</button>
    <button id="menu_pedidos" data-sec="pedidos">Pedidos</button>
    <button id="menu_search" data-sec="search">Buscar</button>
    <hr style="border-color:rgba(255,255,255,0.04);opacity:.06">
    <button id="menu_usuarios" data-sec="usuarios">Mi Cuenta</button>
    <button id="menu_admin_users" data-sec="admin_users">Usuarios (Admin)</button>
    <button id="menu_auditoria" data-sec="auditoria">Auditoría</button>
    <button id="menu_seguimiento" data-sec="seguimiento">Seguimiento</button>
    <button id="menu_roles" data-sec="roles">Gestión de Roles</button>
  </aside>

  <main id="main">
    <section id="dashboard" class="card">
      <h2>Bienvenido</h2>
      <p class="small">Versión Supabase — interfaz móvil lista.</p>
    </section>

    <section id="fundaciones" class="card hidden">
      <h2>Fundaciones</h2>
      <div id="fundacionesContainer"></div>
    </section>

    <section id="items" class="card hidden">
      <h2>Items</h2>
      <div id="itemsContainer"></div>
    </section>

    <section id="conductores" class="card hidden">
      <h2>Conductores y Placas</h2>
      <div id="conductoresContainer"></div>
    </section>

    <section id="pedidos" class="card hidden">
      <h2>Pedidos</h2>
      <div id="pedidosContainer"></div>
      <div class="card">
        <h3>Crear Pedido</h3>
        <label>NIT Fundación / Buscar</label>
        <div style="position:relative;">
          <input id="pd_nit" placeholder="Nit o escriba nombre" />
          <div id="fundResults" class="autocomplete"></div>
        </div>
        <div id="pd_fund_info" class="small" style="margin-top:6px"></div>

        <label>Punto de envío</label>
        <div style="position:relative;">
          <input id="pointSearch" placeholder="Buscar punto por barrio/localidad/ciudad" />
          <div id="pointResults" class="autocomplete"></div>
        </div>

        <label>Dirección del punto de envío</label>
        <input id="pd_point_address" type="text" readonly style="background:#f1f1f1;">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnMaps" class="primary" style="display:none">Ver en Maps</button>
          <button id="btnWaze" class="primary" style="display:none">Ir en Waze</button>
        </div>

        <label>Conductor</label>
        <div style="position:relative;">
          <input id="driverSearch" placeholder="Buscar conductor por nombre o documento" />
          <div id="driverResults" class="autocomplete"></div>
        </div>

        <label>Placa</label>
        <div style="position:relative;">
          <input id="plateSearch" placeholder="Buscar placa" />
          <div id="plateResults" class="autocomplete"></div>
        </div>

        <h4 style="margin-top:12px">Agregar Items</h4>
        <div style="display:flex;gap:8px;flex-direction:column">
          <div style="display:flex;gap:8px">
            <input id="itemSearch" placeholder="Buscar item por nombre" />
            <div id="itemResults" class="autocomplete"></div>
            <input id="pd_kilos" type="number" placeholder="Kilos" style="width:120px">
            <input id="pd_qty" type="number" placeholder="Cant." style="width:100px" value="1">
            <button id="pd_add_item" class="primary">Agregar</button>
          </div>
          <ul id="pd_items_list" style="margin-top:10px"></ul>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnAddPedido" class="primary">Guardar Pedido</button>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <h3>Listado de Pedidos</h3>
        <input id="searchPedidos" placeholder="Buscar..." style="margin-bottom:10px">
        <table class="table" id="pedidosTable"><thead><tr><th>ID</th><th>Fundación</th><th>Fecha</th><th>Kg</th><th>Total</th><th>Acciones</th></tr></thead><tbody id="pedidosBody"></tbody></table>
      </div>
    </section>

    <section id="search" class="card hidden">
      <h2>Buscador Global</h2>
      <input id="globalSearch" placeholder="Buscar..." />
      <div id="globalResults"></div>
    </section>

    <section id="usuarios" class="card hidden">
      <h2>Mi Cuenta</h2>
      <div id="userContainer"></div>
    </section>

    <section id="admin_users" class="card hidden">
      <h2>Gestión Usuarios (Admin)</h2>
      <div id="adminUsersContainer"></div>
    </section>

    <section id="auditoria" class="card hidden">
      <h2>Auditoría</h2>
      <div id="auditContainer"></div>
    </section>

    <section id="seguimiento" class="card hidden">
      <h2>Seguimiento</h2>
      <div id="seguimientoContainer"></div>
    </section>

    <section id="roles" class="card hidden">
      <h2>Gestión de Roles</h2>
      <div class="card">
        <h3>Crear nuevo rol</h3>
        <label>Nombre del rol</label>
        <input id="role_name" placeholder="Ej: Operador, Auditor, Repartidor">
        <h4 style="margin-top:10px;">Permisos</h4>
        <div id="roles_perm_list"></div>
        <button id="btnCreateRole" class="primary" style="margin-top:10px">Crear Rol</button>
      </div>
      <div class="card">
        <h3>Roles existentes</h3>
        <ul id="roleList" class="small" style="padding-left:18px"></ul>
      </div>
    </section>

  </main>
</div>

<!-- Info modal -->
<div id="infoModal">
  <div class="card">
    <h3 id="infoTitle">Información</h3>
    <div id="infoContent" class="small" style="margin-top:8px"></div>
    <div style="margin-top:12px"><button class="primary" onclick="closeInfoModal()">Cerrar</button></div>
  </div>
</div>

<!-- Role edit modal -->
<div id="roleEditModal">
  <div class="box">
    <h3>Editar Rol</h3>
    <input id="edit_role_name" style="width:100%;margin-bottom:8px">
    <h4>Permisos</h4>
    <div id="edit_roles_perm_list"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="btnSaveRoleEdit" class="primary">Guardar</button>
      <button onclick="closeEditRoleModal()">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
/* Minimal supabase client wrapper expected by modules (user will replace with their supabase.js) */
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://uqwiertkefmwoqrbnfqy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxd2llcnRrZWZtd29xcmJuZnF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNTMyNjAsImV4cCI6MjA3OTgyOTI2MH0.1f2ywRxoXAPBmtOZTT51SlNOIKDN8ji547S4Pw7u83o";
export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Basic app state (will be overridden by modules) */
let state = { currentUser:null };

/* UI helpers */
const $ = id => document.getElementById(id);
function show(sec){ document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden')); const el=$(sec); if(el) el.classList.remove('hidden'); document.querySelectorAll('#sidebar button').forEach(b=>b.classList.remove('active')); const btn=document.querySelector(`#sidebar button[data-sec="${sec}"]`); if(btn) btn.classList.add('active'); }

/* Sidebar hamburger */
$('btnMenu').addEventListener('click', ()=>{ document.getElementById('sidebar').classList.toggle('hidden'); });

/* Info modal functions */
window.showInfo = function(title, html){
  $('infoTitle').innerText = title;
  $('infoContent').innerHTML = html;
  $('infoModal').style.display = 'flex';
};
window.closeInfoModal = function(){ $('infoModal').style.display = 'none'; };

/* ROLE MODULE code inserted here (create/edit/delete roles) */
const MODULES = [
  "dashboard","fundaciones","items","conductores","placas","pedidos","search",
  "usuarios","admin_users","auditoria","seguimiento","roles"
];

function renderRolePermCheckboxes(){
  const box = $('roles_perm_list');
  if(!box) return;
  box.innerHTML = MODULES.map(m=>`<div style="margin-bottom:6px"><input type="checkbox" id="perm_${m}" checked> <label for="perm_${m}">${m}</label></div>`).join('');
}
renderRolePermCheckboxes();

async function createRole(){
  const name = $('role_name').value.trim();
  if(!name) return alert('Ingrese nombre de rol');
  const { data: role, error } = await supabase.from('roles').insert({ name }).select().single();
  if(error) return alert('Error creando rol: '+error.message);
  const perms = MODULES.map(m=>({ role_id: role.id, module: m, can_view: !!$('perm_'+m).checked }));
  const { error: permError } = await supabase.from('role_permissions').insert(perms);
  if(permError) return alert('Error guardando permisos: '+permError.message);
  alert('Rol creado');
  $('role_name').value = '';
  loadRoles();
}
$('btnCreateRole').addEventListener('click', createRole);

async function loadRoles(){
  const { data: roles, error } = await supabase.from('roles').select('*').order('id');
  if(error) return console.error(error);
  const ul = $('roleList');
  ul.innerHTML = '';
  roles.forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `<b>${r.name}</b>
      <button onclick="editRole(${r.id})" class="primary" style="margin-left:8px">Editar</button>
      <button onclick="deleteRole(${r.id})" style="margin-left:8px">Eliminar</button>`;
    ul.appendChild(li);
  });
}
window.loadRoles = loadRoles;
loadRoles();

window.editRole = async function(role_id){
  window.currentRoleEditing = role_id;
  const { data: role } = await supabase.from('roles').select('*').eq('id', role_id).single();
  $('edit_role_name').value = role.name;
  const { data: perms } = await supabase.from('role_permissions').select('*').eq('role_id', role_id);
  const box = $('edit_roles_perm_list');
  box.innerHTML = MODULES.map(m=>{ const p = perms.find(x=>x.module===m); return `<div style="margin-bottom:6px"><input type="checkbox" id="edit_perm_${m}" ${p?.can_view ? 'checked': ''}> <label for="edit_perm_${m}">${m}</label></div>`; }).join('');
  $('roleEditModal').style.display = 'flex';
};

window.closeEditRoleModal = function(){ $('roleEditModal').style.display = 'none'; };

$('btnSaveRoleEdit').addEventListener('click', async () => {
  try {
    const id = window.currentRoleEditing;
    const name = $('edit_role_name').value.trim();

    if (!id) {
      alert("Error: No se puede determinar el rol a editar.");
      return;
    }

    // 1. Actualizar nombre del rol
    const { error: roleErr } = await supabase
      .from('roles')
      .update({ name })
      .eq('id', id);

    if (roleErr) {
      alert("Error actualizando nombre del rol: " + roleErr.message);
      return;
    }

    // 2. Borrar permisos actuales
    const { error: delErr } = await supabase
      .from('role_permissions')
      .delete()
      .eq('role_id', id);

    if (delErr) {
      alert("Error borrando permisos anteriores: " + delErr.message);
      return;
    }

    // 3. Insertar nuevos permisos
    const newPerms = MODULES.map(module => ({
      role_id: id,
      module,
      can_view: !!$(`edit_perm_${module}`).checked
    }));

    const { error: insErr } = await supabase
      .from('role_permissions')
      .insert(newPerms);

    if (insErr) {
      alert("Error guardando los nuevos permisos: " + insErr.message);
      return;
    }

    alert("Rol actualizado con éxito.");
    closeEditRoleModal();
    loadRoles();

  } catch (e) {
    alert("Error inesperado: " + e.message);
  }
});


window.deleteRole = async function(id){
  if(!confirm('Eliminar este rol?')) return;
  await supabase.from('role_permissions').delete().eq('role_id', id);
  await supabase.from('roles').delete().eq('id', id);
  loadRoles();
};

/* AUTOCOMPLETE helpers for foundations, drivers, plates, points, items */
function safeText(t){ return (''+t).replace(/'/g,"\'"); }

$('pd_nit').addEventListener('input', async function(){
  const text = this.value.trim();
  const box = $('fundResults');
  if(text.length<2){ box.style.display='none'; $('pd_fund_info').innerHTML=''; window.selectedFoundationId = null; return; }
  const { data } = await supabase.from('fundaciones').select('*').or(`nombre.ilike.%${text}%,nit.ilike.%${text}%`).order('nombre');
  if(!data || data.length===0){ box.innerHTML = '<div>No hay coincidencias</div>'; box.style.display='block'; return; }
  box.innerHTML = data.map(f=>`<div onclick="selectFoundation(${f.id},'${safeText(f.nombre)}','${safeText(f.nit)}')"><b>${f.nombre}</b><br><small>NIT: ${f.nit}</small></div>`).join('');
  box.style.display='block';
});

window.selectFoundation = async function(id,name,nit){
  $('pd_nit').value = `${name} (${nit})`;
  $('fundResults').style.display='none';
  window.selectedFoundationId = id;
  $('pd_fund_info').innerHTML = `<b>${name}</b>`;
  // load shipping points for this foundation into pointResults container for selection
  const { data } = await supabase.from('puntos_envio').select('*').eq('fundacion_id', id).order('barrio');
  const box = $('pointResults');
  if(!data || data.length===0){ box.innerHTML = '<div>No hay puntos registrados</div>'; box.style.display='block'; $('pd_point_address').value=''; $('btnMaps').style.display='none'; $('btnWaze').style.display='none'; return; }
  box.innerHTML = data.map(p=>`<div onclick="selectPoint(${p.id},'${safeText(p.barrio)}','${safeText(p.ciudad)}')">${p.barrio} — ${p.localidad} — ${p.ciudad}</div>`).join('');
  box.style.display='block';
};

window.selectPoint = async function(id,barrio,ciudad){
  $('pointSearch').value = `${barrio} (${ciudad})`;
  $('pointResults').style.display='none';
  window.selectedShippingPointId = id;
  // load point address
  const { data, error } = await supabase.from('puntos_envio').select('barrio,localidad,ciudad,direccion').eq('id', id).single();
  if(error || !data){ $('pd_point_address').value=''; $('btnMaps').style.display='none'; $('btnWaze').style.display='none'; return; }
  const full = `${data.barrio}, ${data.localidad}, ${data.ciudad}${data.direccion ? ' - '+data.direccion : ''}`;
  $('pd_point_address').value = full;
  window.selectedPointFullAddress = full;
  $('btnMaps').style.display='inline-block';
  $('btnWaze').style.display='inline-block';
};

/* Maps and Waze */
window.openMaps = function(){ if(!window.selectedPointFullAddress) return alert('No hay dirección'); const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(window.selectedPointFullAddress)}`; window.open(url,'_blank'); };
window.openWaze = function(){ if(!window.selectedPointFullAddress) return alert('No hay dirección'); const url = `https://www.waze.com/ul?ll=&q=${encodeURIComponent(window.selectedPointFullAddress)}&navigate=yes`; window.open(url,'_blank'); };
$('btnMaps').addEventListener('click', window.openMaps);
$('btnWaze').addEventListener('click', window.openWaze);

/* Autocomplete drivers */
$('driverSearch').addEventListener('input', async function(){
  const txt = this.value.trim();
  const box = $('driverResults');
  if(txt.length<2){ box.style.display='none'; return; }
  const { data } = await supabase.from('conductores').select('*').or(`nombre.ilike.%${txt}%,documento.ilike.%${txt}%`).order('nombre');
  if(!data || data.length===0){ box.innerHTML = '<div>No hay coincidencias</div>'; box.style.display='block'; return; }
  box.innerHTML = data.map(d=>`<div onclick="selectDriver(${d.id},'${safeText(d.nombre)}','${safeText(d.documento)}')"><b>${d.nombre}</b><br><small>${d.documento}</small></div>`).join('');
  box.style.display='block';
});
window.selectDriver = function(id,name,doc){ $('driverSearch').value = `${name} (${doc})`; $('driverResults').style.display='none'; window.selectedDriverId = id; };

/* Autocomplete plates */
$('plateSearch').addEventListener('input', async function(){
  const txt = this.value.trim();
  const box = $('plateResults');
  if(txt.length<2){ box.style.display='none'; return; }
  const { data } = await supabase.from('placas').select('*').ilike('placa', `%${txt}%`).order('placa');
  if(!data || data.length===0){ box.innerHTML='<div>No hay coincidencias</div>'; box.style.display='block'; return; }
  box.innerHTML = data.map(p=>`<div onclick="selectPlate('${safeText(p.placa)}','${safeText(p.tipo)}',${p.id})"><b>${p.placa}</b><br><small>${p.tipo}</small></div>`).join('');
  box.style.display='block';
});
window.selectPlate = function(plate,type,id){ $('plateSearch').value = `${plate} (${type})`; $('plateResults').style.display='none'; window.selectedPlate = plate; window.selectedPlateId = id; };

/* Autocomplete items */
$('itemSearch').addEventListener('input', async function(){
  const txt = this.value.trim();
  const box = $('itemResults');
  if(txt.length<2){ box.style.display='none'; return; }
  const { data } = await supabase.from('items').select('*').ilike('nombre', `%${txt}%`).order('nombre');
  if(!data || data.length===0){ box.innerHTML='<div>No hay coincidencias</div>'; box.style.display='block'; return; }
  box.innerHTML = data.map(it=>`<div onclick="selectItem(${it.id},'${safeText(it.nombre)}',${it.precio})"><b>${it.nombre}</b><br><small>$${it.precio}</small></div>`).join('');
  box.style.display='block';
});
window.selectItem = function(id,name,price){ $('itemSearch').value = `${name}`; $('itemResults').style.display='none'; window.selectedItem = {id,name,price}; };

/* Pedido item list */
let currentPedidoItems = [];
function refreshPdItems(){
  const ul = $('pd_items_list'); ul.innerHTML = '';
  currentPedidoItems.forEach((it,idx)=>{
    const li = document.createElement('li');
    li.innerHTML = `${it.name} x${it.qty} — ${it.kgs||''}kg — $${it.price} <button onclick="removePdItem(${idx})" style="margin-left:8px">Eliminar</button>`;
    ul.appendChild(li);
  });
}
window.removePdItem = function(i){ currentPedidoItems.splice(i,1); refreshPdItems(); };

$('pd_add_item').addEventListener('click', function(){
  if(!window.selectedItem) return alert('Seleccione item');
  const qty = Number($('pd_qty').value)||1;
  const kgs = Number($('pd_kilos')?.value)||0;
  const it = { id: window.selectedItem.id, name: window.selectedItem.name, price: window.selectedItem.price, qty, kgs };
  currentPedidoItems.push(it);
  refreshPdItems();
});

/* Create pedido with validation: nit exists, points exist, items exist */
$('btnAddPedido').addEventListener('click', async function(){
  const nitInput = $('pd_nit').value.trim();
  if(!nitInput) return alert('Ingrese NIT o seleccione fundación');
  if(!window.selectedFoundationId) return alert('Seleccione una fundación válida desde el desplegable');
  // ensure selected point
  if(!window.selectedShippingPointId) return alert('Seleccione punto de envío válido');
  // items
  if(currentPedidoItems.length===0) return alert('Agregue al menos un item');
  // driver
  if(!window.selectedDriverId) return alert('Seleccione conductor');
  // build pedido
  const subtotal = currentPedidoItems.reduce((s,it)=> s + (it.price||0)*(it.qty||1), 0);
  const pedido = {
    codigo: 'PED-'+Date.now(),
    fundacion_id: window.selectedFoundationId,
    punto_id: window.selectedShippingPointId,
    conductor_id: window.selectedDriverId,
    placa_id: window.selectedPlateId || null,
    peaje: 0,
    transporte: 0,
    total: subtotal,
    created_at: new Date().toISOString(),
    items: currentPedidoItems
  };
  const { error } = await supabase.from('pedidos').insert(pedido);
  if(error) return alert('Error creando pedido: '+error.message);
  alert('Pedido creado');
  currentPedidoItems = [];
  refreshPdItems();
  loadPedidos();
});

/* Load pedidos list */
async function loadPedidos(){
  const { data } = await supabase.from('pedidos').select('*, foundation:fundaciones(nombre), point:puntos_envio(barrio)').order('created_at', {ascending:false});
  const tbody = $('pedidosBody'); tbody.innerHTML = '';
  if(!data) return;
  data.forEach(p=>{
    const kilos = (p.items||[]).reduce((s,it)=> s + (it.kgs||0), 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td><td>${p.foundation?.nombre||''}</td><td>${new Date(p.created_at).toLocaleString()}</td><td>${kilos}</td><td>$${p.total||0}</td>
      <td>
        <button onclick="openPedidoMaps(${p.punto_id})">Mapa</button>
        <button onclick="openPedidoWaze(${p.punto_id})">Waze</button>
        <button onclick="viewPedido(${p.id})">Ver</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
window.loadPedidos = loadPedidos;
loadPedidos();

window.openPedidoMaps = async function(pointId){
  const { data, error } = await supabase.from('puntos_envio').select('barrio,localidad,ciudad,direccion').eq('id', pointId).single();
  if(error || !data) return alert('No se pudo obtener dirección');
  const full = `${data.barrio}, ${data.localidad}, ${data.ciudad}${data.direccion ? ' - '+data.direccion : ''}`;
  window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(full)}`,'_blank');
};
window.openPedidoWaze = async function(pointId){
  const { data, error } = await supabase.from('puntos_envio').select('barrio,localidad,ciudad,direccion').eq('id', pointId).single();
  if(error || !data) return alert('No se pudo obtener dirección');
  const full = `${data.barrio}, ${data.localidad}, ${data.ciudad}${data.direccion ? ' - '+data.direccion : ''}`;
  window.open(`https://www.waze.com/ul?ll=&q=${encodeURIComponent(full)}&navigate=yes`,'_blank');
};

/* Generic view functions for drivers/items/funds */
window.viewPedido = async function(pedidoId){
  const { data } = await supabase.from('pedidos').select('*, foundation:fundaciones(*), point:puntos_envio(*), driver:conductores(*)').eq('id', pedidoId).single();
  if(!data) return alert('No encontrado');
  const o = data;
  const html = `<b>ID:</b> ${o.id}<br><b>Fundación:</b> ${o.foundation?.nombre || ''}<br><b>Punto:</b> ${o.point?.barrio || ''} — ${o.point?.localidad || ''}<br><b>Conductor:</b> ${o.driver?.nombre || ''}<br><b>Items:</b><ul>${(o.items||[]).map(it=>'<li>'+it.name+' x'+it.qty+'</li>').join('')}</ul>`;
  showInfo('Pedido '+o.id, html);
};

/* LOGIN UI and logic */
// create login modal DOM if not present
function ensureLoginModal(){
  if(document.getElementById('loginModal')) return;
  const div = document.createElement('div');
  div.id = 'loginModal';
  div.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100000';
  div.innerHTML = `
    <div style="background:#fff;padding:18px;border-radius:10px;width:320px;box-shadow:0 8px 30px rgba(0,0,0,0.2)">
      <h3 style="margin-top:0;text-align:center">Iniciar sesión</h3>
      <label>Usuario</label><input id="lg_user" style="width:100%;margin-bottom:8px">
      <label>Contraseña</label><input id="lg_pass" type="password" style="width:100%;margin-bottom:8px">
      <div style="display:flex;gap:8px;margin-top:12px"><button id="lg_btn" class="primary" style="flex:1">Ingresar</button><button id="lg_demo" style="flex:1">Demo</button></div>
      <div id="lg_msg" class="small" style="margin-top:8px;color:#ff0000;display:none"></div>
    </div>`;
  document.body.appendChild(div);
  document.getElementById('lg_btn').addEventListener('click', doLogin);
  document.getElementById('lg_demo').addEventListener('click', ()=>{ document.getElementById('lg_user').value='admin'; document.getElementById('lg_pass').value='3134630773'; doLogin(); });
}

async function doLogin(){
  const u = document.getElementById('lg_user').value.trim();
  const p = document.getElementById('lg_pass').value.trim();
  const msg = document.getElementById('lg_msg');
  if(!u||!p){ msg.style.display='block'; msg.innerText='Usuario y contraseña son requeridos'; return; }
  msg.style.display='none';
  // query users table in supabase
  const { data, error } = await supabase.from('users').select('*').eq('username', u).eq('pass', p).single();
  if(error || !data){ msg.style.display='block'; msg.innerText='Usuario o clave incorrectos'; return; }
  // success
  window.currentUser = data;
  // store in sessionStorage
  sessionStorage.setItem('erp_user', JSON.stringify({id:data.id, username:data.username, role_id:data.role_id}));
  // remove modal
  const m = document.getElementById('loginModal'); if(m) m.remove();
  // set header and logout button
  document.getElementById('headerUser').innerText = data.username + (data.role_id? '':'') ;
  document.getElementById('btnLogout').style.display = 'inline-block';
  // apply role permissions if available
  applyRolePermissions();
  // load initial data
  loadRoles(); loadPedidos();
}

// show login if no session
function checkSessionAndLogin(){
  const s = sessionStorage.getItem('erp_user');
  if(s){ try{ window.currentUser = JSON.parse(s); document.getElementById('headerUser').innerText = window.currentUser.username; document.getElementById('btnLogout').style.display = 'inline-block'; applyRolePermissions(); return; }catch(e){} }
  ensureLoginModal();
}

async function applyRolePermissions(){
  try{
    if(!window.currentUser || !window.currentUser.role_id) return;
    const { data: perms } = await supabase.from('role_permissions').select('*').eq('role_id', window.currentUser.role_id);
    if(!perms) return;
    // hide/show sidebar buttons based on module names mapping
    perms.forEach(p=>{
      const btn = document.querySelector(`#sidebar button[data-sec="${p.module}"]`);
      if(btn) btn.style.display = p.can_view ? 'block' : 'none';
    });
  }catch(e){ console.error('applyRolePermissions', e); }
}

/* Initial navigation */
document.querySelectorAll('#sidebar button').forEach(b=>b.addEventListener('click', ()=> show(b.dataset.sec)));
 
// Check session and show login if needed
checkSessionAndLogin();
show('dashboard');

</script>
</body>
</html>
